name: CI

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            name: Linux
          - os: macos-latest
            name: macOS
          - os: windows-latest
            name: Windows-MinGW
          - os: windows-latest
            name: Windows-MSVC
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Linux/macOS deps
        if: matrix.name == 'Linux' || matrix.name == 'macOS'
        run: |
          if [ "${{ matrix.name }}" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y ninja-build meson pkg-config \
              libglib2.0-dev libusb-1.0-0-dev libhidapi-dev libftdi1-dev libzip-dev libserialport-dev \
              libglibmm-2.4-dev doxygen
          else
            brew update
            brew install meson ninja pkg-config glib libusb hidapi libftdi libzip libserialport glibmm doxygen
          fi

      - name: Windows MinGW deps
        if: matrix.name == 'Windows-MinGW'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-meson mingw-w64-x86_64-ninja
            mingw-w64-x86_64-cc mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-glib2 mingw-w64-x86_64-libusb
            mingw-w64-x86_64-libftdi mingw-w64-x86_64-hidapi
            mingw-w64-x86_64-libzip mingw-w64-x86_64-libserialport
            mingw-w64-x86_64-glibmm mingw-w64-x86_64-doxygen

      - name: Windows MSVC setup
        if: matrix.name == 'Windows-MSVC'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup sccache
        if: matrix.name == 'Windows-MSVC'
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: Configure env for MSVC + sccache
        if: matrix.name == 'Windows-MSVC'
        shell: pwsh
        run: |
          echo "SCCACHE_CACHE_SIZE=5G" >> $env:GITHUB_ENV
          echo "SCCACHE_DIR=$env:USERPROFILE\.cache\sccache" >> $env:GITHUB_ENV
          echo "CC=cl" >> $env:GITHUB_ENV
          echo "CXX=cl" >> $env:GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> $env:GITHUB_ENV
          echo "VCPKG_FEATURE_FLAGS=manifests,binarycaching" >> $env:GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,C:\vcpkg\cache,readwrite" >> $env:GITHUB_ENV

      - name: Cache sccache (MSVC)
        if: matrix.name == 'Windows-MSVC'
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\sccache
            ~\.cache\sccache
          key: sccache-msvc-${{ runner.os }}-${{ hashFiles('**/meson.build', '**/meson_options.txt') }}
          restore-keys: |
            sccache-msvc-${{ runner.os }}-

      - name: Cache vcpkg state (MSVC)
        if: matrix.name == 'Windows-MSVC'
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            C:\vcpkg\downloads
            C:\Users\runneradmin\AppData\Local\vcpkg\archives
            C:\vcpkg\cache
          key: vcpkg-msvc-${{ runner.os }}-${{ hashFiles('scripts/vcpkg-ports.txt') }}
          restore-keys: |
            vcpkg-msvc-${{ runner.os }}-

      - name: Windows MSVC deps (vcpkg)
        if: matrix.name == 'Windows-MSVC'
        shell: pwsh
        run: |
          vcpkg install pkgconf:x64-windows
          Get-Content scripts/vcpkg-ports.txt | ForEach-Object { vcpkg install $_ }
          pip install meson ninja
          $pkgconf = "C:\vcpkg\installed\x64-windows\tools\pkgconf\pkgconf.exe"
          if (Test-Path $pkgconf) {
            echo "PKG_CONFIG=$pkgconf" >> $env:GITHUB_ENV
            echo "PKG_CONFIG_PATH=C:\vcpkg\installed\x64-windows\lib\pkgconfig" >> $env:GITHUB_ENV
          } else {
            Write-Error "pkgconf not found at $pkgconf"; exit 1
          }

      - name: Cache Meson build dir (MSVC)
        if: matrix.name == 'Windows-MSVC'
        uses: actions/cache@v4
        with:
          path: build
          key: msvc-build-${{ runner.os }}-meson${{ hashFiles('**/meson.build','**/meson_options.txt') }}-cc${{ env.CC }}-triplet${{ env.VCPKG_DEFAULT_TRIPLET }}
          restore-keys: |
            msvc-build-${{ runner.os }}-

      - name: Download libserialport (MSVC)
        if: matrix.name == 'Windows-MSVC'
        id: lsp
        shell: pwsh
        run: |
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/OpenTraceLab/libserialport/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -like "*windows-msvc*" }
          echo "asset=$($asset.browser_download_url)" >> $env:GITHUB_OUTPUT

      - name: Cache libserialport payload (MSVC)
        if: matrix.name == 'Windows-MSVC'
        uses: actions/cache@v4
        with:
          path: C:\_lsp_cache
          key: lsp-${{ steps.lsp.outputs.asset }}

      - name: Install libserialport (MSVC)
        if: matrix.name == 'Windows-MSVC'
        shell: pwsh
        run: |
          New-Item -Force -ItemType Directory C:\_lsp_cache | Out-Null
          $tarPath = "C:\_lsp_cache\libserialport-msvc.tar.gz"
          if (-not (Test-Path $tarPath)) {
            Invoke-WebRequest -Uri "${{ steps.lsp.outputs.asset }}" -OutFile $tarPath
          }
          mkdir libserialport-temp
          tar xzf $tarPath -C libserialport-temp
          Copy-Item -Path libserialport-temp\* -Destination C:\ -Recurse -Force
          echo "PKG_CONFIG_PATH=C:\lib\pkgconfig;$env:PKG_CONFIG_PATH" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Configure (Windows MinGW)
        if: matrix.name == 'Windows-MinGW'
        shell: msys2 {0}
        run: meson setup build -Dbindings_cxx=true

      - name: Configure (Windows MSVC)
        if: matrix.name == 'Windows-MSVC'
        shell: pwsh
        run: |
          # Remove --wipe to preserve build cache, add optimizations
          meson setup build `
            -Dbindings_cxx=true `
            -Db_vscrt=md `
            -Ddefault_library=shared `
            -Dunity=on `
            -Db_pch=true `
            -Db_compiler_launcher=sccache `
            --cmake-prefix-path="C:\vcpkg\installed\x64-windows" `
            --buildtype=debugoptimized

          # Add MSVC-friendly args for parallel compilation and fast debug linking
          meson configure build `
            -Dc_args="/Z7 /MP" `
            -Dcpp_args="/Z7 /MP" `
            -Dc_link_args="/DEBUG:FASTLINK" `
            -Dcpp_link_args="/DEBUG:FASTLINK"

      - name: Configure (Linux/macOS)
        if: matrix.name == 'Linux' || matrix.name == 'macOS'
        run: meson setup build -Dbindings_cxx=true

      - name: Build (Windows MinGW)
        if: matrix.name == 'Windows-MinGW'
        shell: msys2 {0}
        run: meson compile -C build

      - name: Build (Windows MSVC)
        if: matrix.name == 'Windows-MSVC'
        shell: pwsh
        run: |
          # Use parallel compilation now that we have /Z7 and /DEBUG:FASTLINK
          meson compile -C build -v

      - name: Build (Linux/macOS)
        if: matrix.name == 'Linux' || matrix.name == 'macOS'
        run: meson compile -C build

      - name: Test (Windows MinGW)
        if: matrix.name == 'Windows-MinGW'
        shell: msys2 {0}
        run: meson test -C build --print-errorlogs

      - name: Test (Windows MSVC)
        if: matrix.name == 'Windows-MSVC'
        run: meson test -C build --print-errorlogs
        shell: pwsh

      - name: Test (Linux/macOS)
        if: matrix.name == 'Linux' || matrix.name == 'macOS'
        run: meson test -C build --print-errorlogs

      - name: Install (Linux/macOS)
        if: (matrix.name == 'Linux' || matrix.name == 'macOS') && startsWith(github.ref, 'refs/tags/v')
        run: |
          DESTDIR="${PWD}/install" meson install -C build
          PKGCONFIG_DIR=$(find install -type d -name pkgconfig | head -1)
          ACTUAL_PREFIX=$(echo $PKGCONFIG_DIR | sed 's|/lib.*/pkgconfig$||' | sed 's|^install||')
          if [ "${{ matrix.name }}" = "macOS" ]; then
            PLATFORM="macos"
          else
            PLATFORM="linux"
          fi
          echo "Creating tarball from install$ACTUAL_PREFIX"
          tar czf opentracecapture-${PLATFORM}.tar.gz -C install$ACTUAL_PREFIX .

      - name: Install (Windows MinGW)
        if: matrix.name == 'Windows-MinGW' && startsWith(github.ref, 'refs/tags/v')
        shell: msys2 {0}
        run: |
          DESTDIR="${PWD}/install" meson install -C build
          MINGW_PATH=$(find install -type d -name mingw64 | head -1)
          tar czf opentracecapture-windows-mingw.tar.gz -C $MINGW_PATH .

      - name: Install (Windows MSVC)
        if: matrix.name == 'Windows-MSVC' && startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        run: |
          meson install -C build --destdir="$pwd\install"
          $installRoot = (Get-ChildItem -Path install -Recurse -Directory -Filter include | Select-Object -First 1).Parent.FullName
          tar czf opentracecapture-windows-msvc.tar.gz -C $installRoot .

      - name: Upload artifact (Linux)
        if: matrix.name == 'Linux' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: opentracecapture-linux
          path: opentracecapture-*.tar.gz

      - name: Upload artifact (macOS)
        if: matrix.name == 'macOS' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: opentracecapture-macos
          path: opentracecapture-*.tar.gz

      - name: Upload artifact (Windows MinGW)
        if: matrix.name == 'Windows-MinGW' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: opentracecapture-windows-mingw
          path: opentracecapture-*.tar.gz

      - name: Upload artifact (Windows MSVC)
        if: matrix.name == 'Windows-MSVC' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: opentracecapture-windows-msvc
          path: opentracecapture-*.tar.gz

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*/opentracecapture-*.tar.gz
          draft: false
          prerelease: true
